---
- hosts: all
  gather_facts: false
  become: yes
  tasks:
    - import_tasks: ../../raw_install_python.yml

- hosts: osds
  gather_facts: false
  become: yes
  tasks:

    - block:
      - name: check if it is atomic host
        stat:
          path: /run/ostree-booted
        register: stat_ostree
        tags:
          - always

      - name: set_fact is_atomic
        set_fact:
          is_atomic: '{{ stat_ostree.stat.exists }}'
        tags:
          - always

      # Some images may not have lvm2 installed
      - name: install lvm2
        package:
          name: lvm2
          state: present
        register: result
        until: result is succeeded
        when:
          - not is_atomic

      - name: create physical volume
        command: pvcreate "{{ item }}"
        failed_when: false
        with_items:
          - /dev/sdb
          - /dev/sdc
          - /dev/sdd

      - name: create volume group
        command: vgcreate "{{ item.0 }}" "{{ item.1 }}"
        failed_when: false
        with_together:
          - [ 'data_group', 'db_group', 'wal_group' ]
          - [ '/dev/sda', '/dev/sdb', '/dev/sdc' ]

      - name: create logical volume 1
        command: lvcreate --yes -l 50%FREE -n "{{ item.0 }}" "{{ item.1 }}"
        failed_when: false
        with_together:
          - [ 'data-lv', 'db-lv', 'wal-lv' ]
          - [ 'data_group', 'db_group', 'wal_group' ]

      - name: partition /dev/sde for journals
        parted:
          device: /dev/sde
          number: 1
          part_start: 0%
          part_end: 50%
          unit: '%'
          label: gpt
          state: present

      - name: partition /dev/sde for journals
        parted:
          device: /dev/sde
          number: 2
          part_start: 50%
          part_end: 100%
          unit: '%'
          state: present
          label: gpt

      - name: create journals vg from /dev/sde2
        lvg:
          vg: journals
          pvs: /dev/sde2

      - name: create journal1 lv
        command: lvcreate --yes -l 100%FREE -n journal1 journals
        failed_when: false
      when: osd_scenario == 'lvm'
